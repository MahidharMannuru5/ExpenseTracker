<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ’¸ Expense Tracker Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .gradient { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .glass { background: rgba(255,255,255,0.25); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.18); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
    .toast { position: fixed; top: 1rem; right: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #fff; z-index: 100; animation: fadein 0.3s; }
    @keyframes fadein { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="gradient text-white w-full py-4 shadow-lg text-center">
    <h1 class="text-3xl font-bold tracking-wide">ðŸ’¸ Expense Tracker</h1>
  </header>

  <!-- AUTH SECTION -->
  <main id="authSection" class="p-6 max-w-md mx-auto mt-8 space-y-3 bg-white shadow-lg rounded-xl">
    <h2 class="text-2xl font-semibold text-gray-700 text-center">Welcome ðŸ‘‹</h2>
    <input id="email" type="email" placeholder="Email" class="border p-3 w-full rounded-lg" />
    <input id="password" type="password" placeholder="Password" class="border p-3 w-full rounded-lg" />
    <div class="flex gap-2">
      <button id="loginBtn" class="bg-indigo-600 text-white rounded-lg w-1/2 py-2">Login</button>
      <button id="signupBtn" class="bg-purple-600 text-white rounded-lg w-1/2 py-2">Sign Up</button>
    </div>
  </main>

  <!-- DASHBOARD -->
  <main id="dashboard" class="hidden flex-1 flex flex-col items-center p-4">
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 glass">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Dashboard</h2>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg">Logout</button>
      </div>

      <div id="summary" class="text-lg font-semibold text-center mb-4 text-gray-800">Loading summary...</div>

      <!-- EXPENSE TABLE -->
      <div class="overflow-x-auto">
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2 border">Date</th>
              <th class="px-4 py-2 border">Category</th>
              <th class="px-4 py-2 border">Item</th>
              <th class="px-4 py-2 border">Amount</th>
            </tr>
          </thead>
          <tbody id="expenseTable"></tbody>
        </table>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="toggleModal('budgetModal', true)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">ðŸŽ¯ Set Budget</button>
        <button onclick="toggleModal('expenseModal', true)" class="bg-green-600 text-white px-4 py-2 rounded-lg">âž• Add Expense</button>
      </div>
    </div>
  </main>

  <!-- BUDGET MODAL -->
  <div id="budgetModal" class="modal hidden">
    <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
      <h2 class="text-xl font-semibold mb-3">Set Budget</h2>
      <input id="startDate" type="date" class="border p-2 rounded w-full mb-2" />
      <input id="endDate" type="date" class="border p-2 rounded w-full mb-2" />
      <input id="budgetAmount" type="number" placeholder="Budget â‚¹" class="border p-2 rounded w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="toggleModal('budgetModal', false)" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <button id="setBudgetBtn" class="bg-indigo-600 text-white px-3 py-1 rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- EXPENSE MODAL -->
  <div id="expenseModal" class="modal hidden">
    <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
      <h2 class="text-xl font-semibold mb-3">Add Expense</h2>
      <input id="expenseDate" type="date" class="border p-2 rounded w-full mb-2" />
      <input id="category" type="text" placeholder="Category" class="border p-2 rounded w-full mb-2" />
      <input id="item" type="text" placeholder="Item" class="border p-2 rounded w-full mb-2" />
      <input id="amount" type="number" placeholder="Amount â‚¹" class="border p-2 rounded w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="toggleModal('expenseModal', false)" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <button id="addExpenseBtn" class="bg-green-600 text-white px-3 py-1 rounded">Add</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden toast"></div>

  <script>
    const SUPABASE_URL = "https://whmgcmtpvdecrjvfzauu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWdjbXRwdmRlY3JqdmZ6YXV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzOTU2ODAsImV4cCI6MjA3Nzk3MTY4MH0.oX6rFgA6yOnF0PHYA5w05gYtfvGWXkN7lwFS4Zedvho";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const authSection = document.getElementById('authSection');
    const dashboard = document.getElementById('dashboard');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expenseDate').value = today;

    let currentUser = null;
    let currentBudget = null;

    // Toast helper
    function showToast(message, type = "info") {
      const t = document.getElementById("toast");
      t.textContent = message;
      t.classList.remove("hidden");
      t.style.background = type === "error" ? "#ef4444" : type === "success" ? "#10b981" : "#374151";
      setTimeout(() => t.classList.add("hidden"), 3000);
    }

    function toggleModal(id, show) {
      document.getElementById(id).classList.toggle("hidden", !show);
    }

    // AUTH
    async function checkSession() {
      const { data } = await supabase.auth.getSession();
      if (data?.session?.user) {
        currentUser = data.session.user;
        authSection.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadBudget();
        loadExpenses();
      }
    }
    checkSession();

    document.getElementById("signupBtn").onclick = async () => {
      const emailVal = email.value;
      const passwordVal = password.value;
      const { error } = await supabase.auth.signUp({ email: emailVal, password: passwordVal });
      if (error) showToast("âŒ " + error.message, "error");
      else showToast("âœ… Signup successful! Check your email.", "success");
    };

    document.getElementById("loginBtn").onclick = async () => {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value, password: password.value
      });
      if (error) return showToast("âŒ " + error.message, "error");
      currentUser = data.user;
      authSection.classList.add("hidden");
      dashboard.classList.remove("hidden");
      showToast("âœ… Logged in successfully", "success");
      loadBudget();
      loadExpenses();
    };

    document.getElementById("logoutBtn").onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    // BUDGET
    document.getElementById("setBudgetBtn").onclick = async () => {
      const start = startDate.value, end = endDate.value, amount = parseFloat(budgetAmount.value);
      if (!start || !end || !amount) return showToast("âš ï¸ Fill all fields", "error");
      const { error } = await supabase.from("budgets").insert({
        user_id: currentUser.id, start_date: start, end_date: end, total_budget: amount
      });
      if (error) return showToast("âŒ Failed to add budget: " + error.message, "error");
      showToast("âœ… Budget added", "success");
      toggleModal("budgetModal", false);
      loadBudget();
    };

    async function loadBudget() {
      const { data, error } = await supabase
        .from("budgets")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false })
        .limit(1);
      if (error) return showToast("âŒ " + error.message, "error");
      currentBudget = data?.[0];
      updateSummary();
    }

    // EXPENSE
    document.getElementById("addExpenseBtn").onclick = async () => {
      const date = expenseDate.value, cat = category.value, itemVal = item.value, amt = parseFloat(amount.value);
      if (!date || !cat || !amt) return showToast("âš ï¸ Fill all fields", "error");
      const { error } = await supabase.from("expenses").insert({
        user_id: currentUser.id, date, category: cat, item: itemVal, amount: amt
      });
      if (error) return showToast("âŒ Failed to add expense: " + error.message, "error");
      showToast("âœ… Expense added", "success");
      ["category","item","amount"].forEach(id => document.getElementById(id).value="");
      toggleModal("expenseModal", false);
      loadExpenses();
    };

    async function loadExpenses() {
      const { data, error } = await supabase
        .from("expenses")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("date", { ascending: false });
      if (error) return showToast("âŒ " + error.message, "error");

      const tbody = document.getElementById("expenseTable");
      tbody.innerHTML = "";
      let total = 0;
      data.forEach(e => {
        total += e.amount;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class='border px-4 py-2'>${e.date}</td>
                        <td class='border px-4 py-2'>${e.category}</td>
                        <td class='border px-4 py-2'>${e.item || "-"}</td>
                        <td class='border px-4 py-2'>â‚¹${e.amount}</td>`;
        tbody.appendChild(tr);
      });
      updateSummary(total);
    }

    function updateSummary(total = 0) {
      const budgetAmt = currentBudget ? currentBudget.total_budget : 0;
      const remaining = budgetAmt - total;
      document.getElementById("summary").textContent =
        `Spent â‚¹${total} | Remaining â‚¹${remaining} | Budget â‚¹${budgetAmt}`;
    }
  </script>
</body>
</html>
