<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ’¸ Expense Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .gradient { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .glass { background: rgba(255,255,255,0.25); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.18); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
    .toast { position: fixed; top: 1rem; right: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; color: #fff; z-index: 100; animation: fadein 0.3s; }
    @keyframes fadein { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- HEADER -->
  <header class="gradient text-white w-full py-4 shadow-lg text-center">
    <h1 class="text-3xl font-bold tracking-wide">ğŸ’¸ Expense Tracker</h1>
  </header>

  <!-- AUTH -->
  <main id="authSection" class="p-6 max-w-md mx-auto mt-8 space-y-3 bg-white shadow-lg rounded-xl">
    <h2 class="text-2xl font-semibold text-gray-700 text-center">Welcome ğŸ‘‹</h2>
    <input id="email" type="email" placeholder="Email" class="border p-3 w-full rounded-lg" />
    <input id="password" type="password" placeholder="Password" class="border p-3 w-full rounded-lg" />
    <div class="flex gap-2">
      <button id="loginBtn" class="bg-indigo-600 text-white rounded-lg w-1/2 py-2">Login</button>
      <button id="signupBtn" class="bg-purple-600 text-white rounded-lg w-1/2 py-2">Sign Up</button>
    </div>
  </main>

  <!-- DASHBOARD -->
  <main id="dashboard" class="hidden flex-1 flex flex-col items-center p-4">
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 glass">
      <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
        <h2 class="text-2xl font-semibold text-gray-800">Dashboard</h2>
        <div class="flex flex-wrap gap-2">
          <button id="shareBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white sm:px-3 sm:py-2 px-2 py-1 text-sm rounded-lg">Share</button>
          <button id="editBudgetBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white sm:px-3 sm:py-2 px-2 py-1 text-sm rounded-lg">Edit Budget</button>
          <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white sm:px-3 sm:py-2 px-2 py-1 text-sm rounded-lg">Logout</button>
        </div>
      </div>

      <!-- View toggle -->
      <div class="flex flex-wrap justify-center items-center gap-2 mb-4">
        <label class="text-sm font-medium">Viewing:</label>
        <select id="viewSelector" class="border rounded p-1 text-sm"></select>
      </div>

      <div id="summary" class="text-lg font-semibold text-center mb-4 text-gray-800">Loading summary...</div>

      <!-- Date Selector -->
      <div class="flex justify-center items-center gap-3 mb-6">
        <button id="prevDay" class="px-3 py-1 bg-gray-300 rounded-lg">â—€</button>
        <input type="date" id="viewDate" class="border p-2 rounded" />
        <button id="nextDay" class="px-3 py-1 bg-gray-300 rounded-lg">â–¶</button>
      </div>

      <!-- TABLE -->
      <div class="overflow-x-auto">
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2 border">Date</th>
              <th class="px-4 py-2 border">Category</th>
              <th class="px-4 py-2 border">Item</th>
              <th class="px-4 py-2 border">Amount</th>
              <th class="px-4 py-2 border">Action</th>
            </tr>
          </thead>
          <tbody id="expenseTable"></tbody>
        </table>
      </div>

      <!-- ACTION -->
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="toggleModal('expenseModal', true)" class="bg-green-600 text-white sm:px-4 sm:py-2 px-2 py-1 text-sm rounded-lg">â• Add</button>
      </div>
    </div>
  </main>

  <!-- EXPENSE MODAL -->
  <div id="expenseModal" class="modal hidden">
    <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
      <h2 class="text-xl font-semibold mb-3">Add Expense</h2>
      <input id="expenseDate" type="date" class="border p-2 rounded w-full mb-2" />
      <input id="category" type="text" placeholder="Category" class="border p-2 rounded w-full mb-2" />
      <input id="item" type="text" placeholder="Item" class="border p-2 rounded w-full mb-2" />
      <input id="amount" type="number" placeholder="Amount â‚¹" class="border p-2 rounded w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="toggleModal('expenseModal', false)" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <button id="addExpenseBtn" class="bg-green-600 text-white px-3 py-1 rounded">Add</button>
      </div>
    </div>
  </div>

  <!-- BUDGET MODAL -->
  <div id="budgetModal" class="modal hidden">
    <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
      <h2 class="text-xl font-semibold mb-3">Edit Budget</h2>
      <input id="startDate" type="date" class="border p-2 rounded w-full mb-2" />
      <input id="endDate" type="date" class="border p-2 rounded w-full mb-2" />
      <input id="budgetAmount" type="number" placeholder="Budget â‚¹" class="border p-2 rounded w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="toggleModal('budgetModal', false)" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <button id="setBudgetBtn" class="bg-indigo-600 text-white px-3 py-1 rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- SHARE MODAL -->
  <div id="shareModal" class="modal hidden">
    <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
      <h2 class="text-xl font-semibold mb-3">Share Expenses</h2>
      <input id="shareEmail" type="email" placeholder="Friend's Email" class="border p-2 rounded w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="toggleModal('shareModal', false)" class="bg-gray-300 px-3 py-1 rounded">Cancel</button>
        <button id="shareSaveBtn" class="bg-yellow-500 text-white px-3 py-1 rounded">Share</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="hidden toast"></div>

  <script>
    const SUPABASE_URL = "https://whmgcmtpvdecrjvfzauu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWdjbXRwdmRlY3JqdmZ6YXV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzOTU2ODAsImV4cCI6MjA3Nzk3MTY4MH0.oX6rFgA6yOnF0PHYA5w05gYtfvGWXkN7lwFS4Zedvho";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null, currentBudget = [], viewDate = new Date(), viewingUserId = null;

    function formatDate(date){ return date.toISOString().split("T")[0]; }
    function showToast(msg,type="info"){const t=document.getElementById("toast");t.textContent=msg;t.classList.remove("hidden");t.style.background=type==="error"?"#ef4444":type==="success"?"#10b981":"#374151";setTimeout(()=>t.classList.add("hidden"),3000);}
    function toggleModal(id,show){document.getElementById(id).classList.toggle("hidden",!show);}

    async function checkSession(){
      const { data }=await supabase.auth.getSession();
      if(data?.session?.user){
        currentUser=data.session.user;
        document.getElementById("authSection").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("viewDate").value=formatDate(viewDate);
        document.getElementById("expenseDate").value=formatDate(viewDate);
        viewingUserId=currentUser.id;
        loadSharedList();
        loadBudget();
        loadExpenses();
      }
    }
    checkSession();

    document.getElementById("signupBtn").onclick=async()=>{
      const {error}=await supabase.auth.signUp({email:email.value,password:password.value});
      if(error)return showToast("âŒ "+error.message,"error");
      showToast("âœ… Signup successful! Verify email.","success");
    };

    document.getElementById("loginBtn").onclick=async()=>{
      const {data,error}=await supabase.auth.signInWithPassword({email:email.value,password:password.value});
      if(error)return showToast("âŒ "+error.message,"error");
      currentUser=data.user;viewingUserId=currentUser.id;
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("viewDate").value=formatDate(viewDate);
      document.getElementById("expenseDate").value=formatDate(viewDate);
      loadSharedList();loadBudget();loadExpenses();
    };

    document.getElementById("logoutBtn").onclick=async()=>{await supabase.auth.signOut();location.reload();};

    document.getElementById("shareBtn").onclick=()=>toggleModal("shareModal",true);
    document.getElementById("shareSaveBtn").onclick=async()=>{
      const email=document.getElementById("shareEmail").value.trim();
      if(!email)return showToast("âš ï¸ Enter email","error");
      const {data:users}=await supabase.from("auth.users").select("id,email");
      const user=users?.find(u=>u.email===email);
      if(!user)return showToast("âŒ User not found","error");
      if(user.id===currentUser.id)return showToast("âš ï¸ Cannot share with yourself","error");
      const {error}=await supabase.from("shared_expenses").insert({owner_id:currentUser.id,viewer_id:user.id,can_view:true});
      if(error)return showToast("âŒ "+error.message,"error");
      showToast("âœ… Shared successfully","success");
      toggleModal("shareModal",false);
      loadSharedList();
    };

    async function loadSharedList(){
      const {data:shared,error}=await supabase.from("shared_expenses").select("owner_id,auth.users(email)").eq("viewer_id",currentUser.id);
      const {data:myself}=await supabase.from("auth.users").select("id,email").eq("id",currentUser.id);
      const select=document.getElementById("viewSelector");select.innerHTML="";
      const myOpt=document.createElement("option");myOpt.value=currentUser.id;myOpt.textContent="My Expenses";select.appendChild(myOpt);
      if(shared){shared.forEach(s=>{const opt=document.createElement("option");opt.value=s.owner_id;opt.textContent="Shared: "+s.users.email;select.appendChild(opt);});}
      select.value=viewingUserId=currentUser.id;
      select.onchange=()=>{viewingUserId=select.value;loadBudget();loadExpenses();};
    }

    document.getElementById("editBudgetBtn").onclick=()=>{toggleModal("budgetModal",true);if(currentBudget[0]){startDate.value=currentBudget[0].start_date;endDate.value=currentBudget[0].end_date;budgetAmount.value=currentBudget[0].total_budget;}};

    document.getElementById("setBudgetBtn").onclick=async()=>{
      const s=startDate.value,e=endDate.value,a=parseFloat(budgetAmount.value);
      if(!s||!e||!a)return showToast("âš ï¸ Fill all fields","error");
      let q=supabase.from("budgets");
      if(currentBudget[0]){const {error}=await q.update({start_date:s,end_date:e,total_budget:a}).eq("id",currentBudget[0].id);if(error)return showToast("âŒ "+error.message,"error");showToast("âœ… Budget updated","success");}
      else{const {error}=await q.insert({user_id:currentUser.id,start_date:s,end_date:e,total_budget:a});if(error)return showToast("âŒ "+error.message,"error");showToast("âœ… Budget added","success");}
      toggleModal("budgetModal",false);loadBudget();
    };

    async function loadBudget(){
      const {data,error}=await supabase.from("budgets").select("*").eq("user_id",viewingUserId).order("created_at",{ascending:false});
      if(error)return showToast("âŒ "+error.message,"error");
      currentBudget=data;updateSummary();
    }

    document.getElementById("addExpenseBtn").onclick=async()=>{
      const d=expenseDate.value,c=category.value,i=item.value,a=parseFloat(amount.value);
      if(!d||!c||!a)return showToast("âš ï¸ Fill all fields","error");
      const {error}=await supabase.from("expenses").insert({user_id:currentUser.id,date:d,category:c,item:i,amount:a});
      if(error)return showToast("âŒ "+error.message,"error");
      showToast("âœ… Expense added","success");["category","item","amount"].forEach(x=>document.getElementById(x).value="");
      toggleModal("expenseModal",false);loadExpenses();
    };

    async function deleteExpense(id){
      const {error}=await supabase.from("expenses").delete().eq("id",id);
      if(error)return showToast("âŒ "+error.message,"error");
      showToast("ğŸ—‘ï¸ Deleted","success");loadExpenses();
    }

    async function loadExpenses(){
      const date=document.getElementById("viewDate").value;
      const {data,error}=await supabase.from("expenses").select("*").eq("user_id",viewingUserId).eq("date",date).order("created_at",{ascending:false});
      if(error)return showToast("âŒ "+error.message,"error");
      const tbody=document.getElementById("expenseTable");tbody.innerHTML="";let total=0;
      data.forEach(e=>{total+=e.amount;const tr=document.createElement("tr");
        tr.innerHTML=`<td class='border px-4 py-2'>${e.date}</td><td class='border px-4 py-2'>${e.category}</td><td class='border px-4 py-2'>${e.item||"-"}</td><td class='border px-4 py-2'>â‚¹${e.amount}</td><td class='border px-4 py-2 text-center'>${(viewingUserId===currentUser.id)?`<button onclick="deleteExpense('${e.id}')" class='bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm'>ğŸ—‘ï¸</button>`:"-"}</td>`;
        tbody.appendChild(tr);});
      updateSummary(total);
    }

    function updateSummary(total=0){
      const date=document.getElementById("viewDate").value;
      const active=currentBudget?.find(b=>date>=b.start_date&&date<=b.end_date);
      if(active){const b=active.total_budget,r=b-total;
        document.getElementById("summary").textContent=`Spent â‚¹${total} | Remaining â‚¹${r} | Budget â‚¹${b}`;
      }else{document.getElementById("summary").textContent=`Spent â‚¹${total} | No active budget`;}
    }

    document.getElementById("prevDay").onclick=()=>{viewDate.setDate(viewDate.getDate()-1);document.getElementById("viewDate").value=formatDate(viewDate);loadExpenses();};
    document.getElementById("nextDay").onclick=()=>{viewDate.setDate(viewDate.getDate()+1);document.getElementById("viewDate").value=formatDate(viewDate);loadExpenses();};
    document.getElementById("viewDate").onchange=()=>{viewDate=new Date(viewDate.value);loadExpenses();};
  </script>
</body>
</html>
